我已经根据你提供的 V2.0 日志，将增强版功能整合进你的流程文档中，并标注了新增功能和测试情况。下面是更新后的 **完整流程说明（含 V2.0 功能）**：

---

## 游戏装备图像识别系统流程详解（增强版 V2.0）

### 系统概述

这是一个基于图像识别技术的游戏装备自动识别系统，采用多重算法架构，能够从游戏截图中自动识别出与基准装备图相匹配的装备，并识别装备金额。V2.0 引入了特征缓存优化、图像质量检测、可视化调试及图像哈希重复检测等功能，显著提升识别效率和系统稳定性。

---

### 完整工作流程（四步骤 + V2.0增强功能）

#### 步骤1：获取原始图片

**目的**：检查和选择游戏截图

1. **检查游戏截图目录** (`images/game_screenshots/`)

   * 系统检查该目录是否存在
   * 列出所有截图文件（支持 .png, .jpg, .jpeg, .webp 格式）
   * 当前示例截图：MuMu-20251122-085551-742.png、MuMu-20251122-201210-068.png、MuMu-20251122-201226-303.png

2. **截图要求**

   * 截图应包含完整装备界面
   * 装备应排列整齐，便于后续切割
   * 截图质量清晰，无模糊或变形

---

#### 步骤2：分割原始图片

**目的**：将游戏截图分割成单个装备图片

1. **切割参数配置**（来自 config.json）

```json
"fixed_grid": [5, 2],           // 5列2行装备网格
"fixed_item_width": 210,        // 单个装备宽度210px
"fixed_item_height": 160,       // 单个装备高度160px
"fixed_margin_left": 10,        // 左边距10px
"fixed_margin_top": 275,        // 上边距275px
"fixed_h_spacing": 15,          // 横向间隔15px
"fixed_v_spacing": 20           // 纵向间隔20px
```

2. **切割过程**

   * 使用固定坐标切割方法
   * 按配置网格提取装备
   * 每个装备单独保存为图片文件
   * 创建时间戳目录（如 20251123_104231/）组织切割结果

3. **圆形标记功能**（V2.0 新增）

   * 在每个切割后的装备图片顶部添加红色圆形标记
   * 圆形直径默认 116 px，用于 OCR 金额识别
   * 保存原图和纯圆形区域（透明背景）

4. **文件组织**

   * 主目录：`images/cropped_equipment/20251123_104231/`（原图）
   * 标记目录：`images/cropped_equipment_marker/20251123_104231/`（带圆形标记）
   * 文件重命名为顺序编号：01.png, 02.png ... 30.png

---

#### 步骤3：装备识别匹配

**目的**：使用基准装备对比切割后的图片，识别装备名称

1. **基准装备库** (`images/base_equipment/`)

   * 包含 90+ 个基准装备图片（.webp）
   * 例如：1000bp.webp、abyssal.webp、aegiraxe.webp

2. **匹配算法**

   * 默认使用 ORB 特征匹配算法
   * 支持高级彩色模板匹配算法
   * 支持传统 dHash 算法
   * 默认匹配阈值 80%

3. **匹配过程**

   * 遍历基准装备与切割后装备匹配
   * 计算相似度，超过阈值即匹配成功
   * 为匹配装备添加装备名称后缀

     * 示例：01.png → 01_victoriansword.png

4. **特征缓存优化**（V2.0 新增）

   * 预计算基准装备 ORB 特征
   * 缓存至 `images/cache/equipment_features.pkl`
   * 显著提升匹配速度（70-80%）
   * 自动更新缓存，支持增量更新

5. **图像哈希重复检测**（V2.0 新增）

   * 检测重复或相似装备图片
   * 防止重复计算特征

---

#### 步骤4：整合装备名称和金额识别结果

**目的**：整合装备名称和金额识别结果到统一 CSV 文件

1. **OCR 金额识别**

   * 使用 EasyOCR 引擎识别圆形标记中的金额
   * 区域配置：左 27 px，右 145 px，上 122 px，下 152 px
   * 支持数字模式匹配：`\d+`
   * 置信度阈值：0.8

2. **结果整合**

   * 读取装备名称（来自步骤3）
   * 读取金额信息（来自 OCR）
   * 整合到 CSV 文件：`ocr_rename_records.csv`

3. **CSV记录格式**

```
original_filename,new_filename,equipment_name,amount,confidence
01.png,01_315.png,未知装备,315,0.958
04.png,04.png,victoriansword,,
12.png,12_woodspear_415.png,woodspear,415,0.972
```

4. **文件重命名**

   * 成功识别金额：01.png → 01_315.png
   * 成功识别装备：04.png → 04_victoriansword.png
   * 两者都识别：12.png → 12_woodspear_415.png

---

### 系统特点（V2.0 增强版）

1. **多重算法支持**

   * ORB 特征匹配：最高准确率 >98%
   * 高级彩色模板匹配：保留颜色信息 >95%
   * dHash 算法：最快速度 >90%

2. **智能文件管理**

   * 时间戳目录组织，避免覆盖
   * 自动清理旧文件选项
   * 双目录保存（原图 + 标记图）

3. **灵活配置**

   * 配置文件支持切割参数、匹配阈值、OCR 设置
   * 支持运行时动态调整参数

4. **完整日志记录**

   * 记录每步骤执行情况
   * 保存匹配结果和置信度
   * 支持性能监控和调试

5. **V2.0 新增功能**

   * **特征缓存管理与自动更新**：加速匹配、支持增量更新
   * **图像质量检测**：检测模糊或异常图片
   * **可视化调试器**：生成匹配及特征可视化报告
   * **图像哈希重复检测**：避免重复识别


