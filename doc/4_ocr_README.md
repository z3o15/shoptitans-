# 5_ocr.py - OCR金额识别工具

## 功能概述

专注于装备金额识别的OCR工具，使用EasyOCR引擎自动识别游戏装备图标中的金额信息。这是自动化装备处理流程的第5步，将图像中的数字金额转换为结构化数据表格。

## 核心特性

### OCR识别引擎
- **EasyOCR引擎**: 强大的多语言OCR识别
- **中文路径支持**: 完美支持包含中文字符的文件路径
- **智能回退机制**: 多种预处理策略确保识别成功率
- **自适应置信度**: 动态调整置信度阈值提高识别率

### 数据处理功能
- **批量处理**: 自动处理目录中的所有图像文件
- **结果验证**: 对识别结果进行合理性检查
- **数据合并**: 与装备匹��结果自动合并
- **报告生成**: 生成详细的处理报告

## 使用方法

### 基本用法
```bash
python step_tests/5_ocr.py
```

### 编程接口
```python
from step_tests._5_ocr import process_amount_images

# 使用默认路径
success = process_amount_images()

# 使用自定义路径
success = process_amount_images(
    input_dir="path/to/input",
    output_dir="path/to/output"
)
```

## 函数参数

### process_amount_images() 函数

#### 参数说明

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `input_dir` | 字符串或None | `output_enter_image/equipment_crop` | 输入图像目录路径 |
| `output_dir` | 字符串或None | `output/ocr` | 输出结果目录路径 |

#### 参数使用示例

```python
# 使用默认路径
process_amount_images()

# 指定输入输出路径
process_amount_images(
    input_dir="custom/input/dir",
    output_dir="custom/output/dir"
)

# 只指定输入路径，使用默认输出路径
process_amount_images(input_dir="custom/input/dir")
```

#### 返回值
- **类型**: `bool`
- **True**: 处理成功完成
- **False**: 处理过程中出现错误

## 输入要求

### 输入目录结构
```
output_enter_image/equipment_crop/
├── 01.png
├── 02.png
├── 03.png
└── ...
```

### 图像要求
- **支持格式**: `.png`, `.jpg`, `.jpeg`, `.bmp`, `.tiff`, `.webp`
- **文件内容**: 包含清晰可识别的数字金额
- **图像质量**:
  - 分辨率适中，数字清晰可见
  - 对比度良好，数字与背景区分明显
  - 无严重模糊或扭曲
- **文件大小**: 建议单张图像不超过10MB

### 金额文本特点
- **数字格式**: 支持整数和小数（如：1000, 1,000, 1000.5）
- **货币符号**: 可选包含货币符号
- **千位分隔符**: 支持逗号分隔的千位符
- **语言支持**: 优化的英文数字识别

## 输出结果

### 输出目录结构
```
output/ocr/
├── equipment_amount_results_YYYYMMDD_HHMMSS.csv  # 主要结果文件
├── report_YYYYMMDD_HHMMSS.txt                   # 详细报告
└── log.txt                                      # 处理日志
```

### CSV结果文件格式
```csv
文件名,识别金额,置信度,状态
01.png,1500,0.95,成功
02.png,2,500,0.87,成功
03.png,,0.00,识别失败
```

### 报告文件内容
```
装备图片OCR识别结果汇总报告
==================================================

处理时间: 2025-11-26 21:44:55
匹配方法: EasyOCR金额识别
总处理数量: 10

识别质量统计:
  平均置信度: 0.754
  高置信度识别 (>0.8): 6 个 (60.0%)
  中置信度识别 (0.6-0.8): 3 个 (30.0%)
  低置信度识别 (≤0.6): 1 个 (10.0%)

最佳识别结果 (前10名):
--------------------------------------------------
 1. 01.jpg | 识别金额: 617,650 | 置信度: 1.00
 2. 02.jpg | 识别金额: 415,000 | 置信度: 0.72
 ...
```

### 置信度说明
- **高置信度 (>0.8)**: 识别结果可靠
- **中置信度 (0.6-0.8)**: 识别结果基本可靠，建议人工检查
- **低置信度 (≤0.6)**: 识别结果不确定，需要人工验证

## 技术实现

### OCR处理流程
1. **图像预处理**:
   - 使用 `np.fromfile + cv2.imdecode` 支持中文路径
   - 图像增强和噪声去除
   - 尺寸标准化处理

2. **EasyOCR识别**:
   - 英文本地识别模型
   - 多种置信度阈值尝试
   - 结果后处理和格式化

3. **结果验证**:
   - 金额格式检查
   - 数值合理性验证
   - 置信度评估

4. **自动回退**:
   - 低置信度时降低阈值重试
   - 多种预处理策略尝试
   - 智能结果选择

### 中文路径支持
使用特殊的图像读取方式确保中文路径兼容：
```python
# 标准方式（不支持中文）
image = cv2.imread(image_path)

# 改进方式（支持中文）
image_array = np.fromfile(image_path, dtype=np.uint8)
image = cv2.imdecode(image_array, cv2.IMREAD_COLOR)
```

## 性能特性

### 处理能力
- **单张处理**: 0.1-3秒（取决于图像复杂度）
- **批量处理**: 支持同时处理大量图像
- **内存优化**: 及时释放图像内存
- **错误恢复**: 单张图像失败不影响整体处理

### 识别准确性
- **准确率**: 在清晰图像上可达95%以上
- **适应性**: 能处理不同字体和样式
- **容错性**: 对图像质量有一定容忍度

## 使用场景

### 标准工作流程
1. **准备图像**: 确保装备金额图像在正确目录
2. **运行OCR**: `python step_tests/5_ocr.py`
3. **检查结果**: 查看生成的CSV文件和报告
4. **人工验证**: 检查低置信度的识别结果
5. **数据修正**: 根据需要修正识别错误的金额

### 编程集成
```python
# 基本集成
from step_tests._5_ocr import process_amount_images

if process_amount_images():
    print("OCR处理成功")
else:
    print("OCR处理失败")

# 自定义路径集成
success = process_amount_images(
    input_dir="data/equipment_amounts",
    output_dir="results/ocr_output"
)
```

## 故障排除

### 常见问题

#### Q: 识别准确率低
**A**: 可能的解决方法：
- **图像质量改善**: 使用更高分辨率和更清晰的图像
- **光照调整**: 确保金额区域光线充足
- **字体清晰**: 确保数字字体清晰可读
- **对比度提升**: 增强数字与背景的对比度

#### Q: 无法识别金额
**A**: 检查以下内容：
- **图像格式**: 确保使用支持的图像格式
- **数字存在**: 确认图像中确实包含数字金额
- **文件路径**: 检查路径是否正确，特别是中文路径
- **文件权限**: 确保有读取图像文件的权限

#### Q: 处理速度慢
**A**: 优化建议：
- **减少文件数量**: 分批处理大量文件
- **图像尺寸优化**: 使用适当尺寸的图像
- **硬件升级**: 考虑使用GPU加速（EasyOCR支持）
- **关闭其他程序**: 释放更多系统资源

#### Q: 中文路径问题
**A**: 确认以下设置：
- **使用新版程序**: 确保使用支持中文路径的版本
- **编码设置**: 确保系统使用UTF-8编码
- **路径格式**: 避免使用特殊字符

### 错误信息解读

#### 常见错误类型
- **文件读取错误**: 检查文件路径和权限
- **OCR引擎错误**: 确认EasyOCR正确安装
- **内存不足**: 减少批处理大小或增加系统内存
- **格式转换错误**: 检查图像文件完整性

#### 调试方法
1. **查看日志文件**: `output/ocr/log.txt` 包含详细的处理信息
2. **检查报告文件**: `report_*.txt` 显示识别统计和质量指标
3. **单文件测试**: 使用少量文件测试参数设置
4. **置信度分析**: 关注置信度分布，调整阈值设置

## 配置选项

### 内部参数（代码中可调整）
```python
# 置信度阈值配置
HIGH_CONFIDENCE_THRESHOLD = 0.8    # 高置信度阈值
MEDIUM_CONFIDENCE_THRESHOLD = 0.6  # 中置信度阈值
LOW_CONFIDENCE_THRESHOLD = 0.6     # 低置信度阈值

# EasyOCR配置
OCR_LANGUAGE = ['en']               # 识别语言
GPU_MODE = False                    # GPU模式（需要CUDA支持）
```

### 环境变量
- **PYTHONPATH**: 确保能正确导入项目模块
- **CUDA_VISIBLE_DEVICES**: GPU设备选择（如使用GPU）

## 最佳实践

### 数据准备
1. **图像质量**: 使用高分辨率、清晰的金额图像
2. **文件命名**: 使用有意义的文件名便于管理
3. **目录组织**: 保持输入目录整洁
4. **备份策略**: 处理前备份重要数据

### 处理优化
1. **分批处理**: 大量数据分批处理
2. **结果验证**: 及时检查识别结果质量
3. **参数调优**: 根据数据特点调整置信度阈值
4. **错误处理**: 建立错误处理和重试机制

### 质量控制
1. **人工抽检**: 定期人工检查识别结果
2. **阈值调整**: 根据准确率要求调整置信度阈值
3. **反馈循环**: 建立错误反馈和改进机制

## 技术依赖

### 核心依赖
- **EasyOCR**: OCR识别引擎
- **OpenCV**: 图像处理
- **NumPy**: 数值计算
- **Pillow**: 图像格式支持

### 可选依赖
- **CUDA**: GPU加速（需要兼容的NVIDIA显卡）
- **额外语言包**: 如需识别其他语言

## 相关工具

- **3_match.py**: 装备匹配工具
- **3_match_cached.py**: 缓存优化版装备匹配
- **auto_equipment_processor.py**: 完整自动化处理流程
- **build_cache.py**: 特征缓存构建工具

## 更新日志

### 当前版本特性
- 完整的中文路径支持
- 智能置信度调整机制
- 与装备匹配结果的自动合并
- 详细的处理报告和统计信息
- 优化的错误处理和日志记录