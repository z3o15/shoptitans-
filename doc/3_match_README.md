# 3_match.py - 装备匹配工具（标准版）

## 功能概述

使用LAB色彩空间两阶段匹配策略，将待匹配装备图标与基准装备库进行匹配，识别每个装备图标的最佳匹配结果。这是自动化装备处理流程的第3步，提供详细的匹配状态显示和高置信度文件重命名功能。

## 核心特性

### 匹配算法
- **LAB色彩空间**: 使用感知均匀的LAB颜色空间进行颜色匹配
- **两阶段策略**:
  1. 模板匹配筛选候选装备
  2. 颜色相似度精确匹配
- **多模板方法**: 结合多种模板匹配算法提高准确性

### 输出功能
- **完整状态表格**: 显示所有文件的匹配状态
- **高置信度重命名**: 自动重命名高置信度匹配的文件
- **CSV结果导出**: 生成详细的匹配结果表格
- **对比图像保存**: 可选保存匹配对比图像

## 命令行参数

### 基本用法
```bash
python step_tests/3_match.py
```

### 详细参数
```bash
python step_tests/3_match.py [选项]
```

#### 可选参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--base-dir` | 字符串 | `output_enter_image/base_equipment` | 基准装备图像目录路径 |
| `--compare-dir` | 字符串 | `output_enter_image/equipment_transparent` | 待匹配装备目录路径 |
| `--output-dir` | 字符串 | `output/matching` | 输出目录路径 |
| `--no-comparisons` | 标志 | False | 不保存对比图像 |
| `--no-circle-mask` | 标志 | False | 禁用圆形掩码（使用全图） |

### 参数使用示例

```bash
# 使用默认路径
python step_tests/3_match.py

# 指定自定义路径
python step_tests/3_match.py --base-dir "custom/base" --compare-dir "custom/equipment" --output-dir "custom/output"

# 不保存对比图像（加快处理速度）
python step_tests/3_match.py --no-comparisons

# 禁用圆形掩码，使用完整图像匹配
python step_tests/3_match.py --no-circle-mask
```

## 输入要求

### 基准装备目录
- **路径**: `output_enter_image/base_equipment/`
- **格式要求**:
  - 支持的格式: `.png`, `.jpg`, `.jpeg`, `.bmp`, `.tiff`
  - 文件名应包含装备的标识信息
- **质量要求**:
  - 高质量基准图像
  - 统一的图像尺寸
  - 清晰的装备特征

### 待匹配装备目录
- **路径**: `output_enter_image/equipment_transparent/`
- **格式要求**: 与基准装备相同
- **内容**: 从步骤2生成的圆形透明装备图标

## 输出结果

### 输出目录结构
```
output/matching/
├── matching_results_YYYYMMDD_HHMMSS.csv    # 匹配结果CSV表格
└── comparisons/                              # 对比图像目录（可选）
    ├── matching_results_YYYYMMDD_HHMMSS.json
    ├── matching_summary_YYYYMMDD_HHMMSS.txt
    └── [各对比图像文件]
```

### 匹配状态表格

程序运行时会显示完整的匹配状态表格：

```
所有文件匹配状态：
--------------------------------------------------------------------------------
文件名                       匹配装备                 置信度得分      状态
--------------------------------------------------------------------------------
01_circle.png             yulescroll             58.1% 未匹配
02_circle.png             zweihander             92.1% 已匹配
03_circle.png             yggdrasilbranch        68.1% 未匹配
--------------------------------------------------------------------------------
```

### CSV文件格式
```csv
原始名称,匹配装备名称
01_circle,
02_circle,zweihander
03_circle,
```

### 高置信度重命名
- **阈值**: 90% 置信度
- **重命名格式**: `原文件名_匹配装备名.png`
- **示例**: `02_circle.png` → `02_circle_zweihander.png`

## 匹配算法详解

### 第一阶段：LAB色彩空间模板匹配
1. **颜色空间转换**: RGB → LAB
2. **多方法模板匹配**:
   - TM_CCOEFF_NORMED
   - TM_CCORR_NORMED
   - TM_SQDIFF_NORMED
3. **加权评分**: 不同方法的权重组合

### 第二阶段：颜色相似度匹配
1. **直方图比较**: 比较LAB颜色直方图
2. **相关性计算**: 使用HISTCMP_CORREL方法
3. **综合评分**: 结合模板匹配和颜色相似度

### 最终评分公式
```
综合得分 = (1.0 - 颜色权重) × 模板得分 + 颜色权重 × 颜色相似度
```
- 默认颜色权重: 0.3

## 性能特性

### 处理能力
- **处理速度**: 平均每张图像 0.05-0.1 秒
- **内存使用**: 优化的内存管理
- **并发处理**: 支持批量处理多张图像

### 准确性
- **高置信度识别**: 90%以上阈值的匹配可靠性很高
- **误匹配率**: 经过优化的算法误匹配率较低
- **一致性**: 相同输入产生相同结果

## 使用场景

### 标准工作流程
1. **准备数据**: 确保基准装备和待匹配装备已准备
2. **运行匹配**: `python step_tests/3_match.py`
3. **查看结果**: 检查匹配状态表格
4. **处理高置信度匹配**: 查看重命名的文件
5. **分析低置信度结果**: 人工检查未匹配的文件

### 批量处理
```bash
# 处理大量文件，不保存对比图像以提高速度
python step_tests/3_match.py --no-comparisons

# 使用自定义配置
python step_tests/3_match.py --base-dir "path/to/base" --compare-dir "path/to/compare"
```

### 调试模式
```bash
# 保存详细的对比图像用于分析
python step_tests/3_match.py

# 禁用圆形掩码测试不同匹配策略
python step_tests/3_match.py --no-circle-mask
```

## 故障排除

### 常见问题

#### Q: 提示"基准图像目录不存在"
**A**: 检查以下内容：
- 确保 `output_enter_image/base_equipment/` 目录存在
- 确认目录中有基准装备图像
- 检查图像格式是否受支持

#### Q: 匹配准确率低
**A**: 可能的原因和解决方法：
- **基准图像质量差**: 使用高质量、清晰的基准图像
- **光照条件不同**: 确保待匹配图像与基准图像的光照条件相似
- **装备角度不同**: 尝试从不同角度截取基准图像
- **图像分辨率不一致**: 统一所有图像的分辨率

#### Q: 处理速度慢
**A**: 优化建议：
- 使用 `--no-comparisons` 参数禁用对比图像保存
- 减少同时处理的文件数量
- 确保有足够的系统内存
- 关闭其他占用资源的程序

#### Q: 没有高置信度匹配
**A**: 可能的原因：
- **基准库不完整**: 添加更多相关的基准装备图像
- **匹配阈值过高**: 当前阈值为90%，可考虑调整
- **图像质量问题**: 改善图像质量和一致性

### 错误处理

#### 自动错误恢复
- 单个文件处理失败不会影响整体流程
- 详细的错误日志记录
- 优雅的程序退出机制

#### 常见错误信息
- **无法加载图像**: 检查文件格式和路径
- **内存不足**: 减少批处理大小或增加系统内存
- **权限错误**: 检查输出目录的写入权限

## 配置调优

### 匹配参数调整
以下参数可在代码中调整（需要修改源码）：
- **高置信度阈值**: 默认90%，可根据需要调整
- **颜色权重**: 默认0.3，影响颜色匹配的权重
- **模板方法权重**: 不同模板匹配方法的权重分配

### 圆形掩码配置
- **默认启用**: 专注于装备的圆形区域
- **禁用选项**: 使用完整图像进行匹配
- **适用场景**: 根据装备形状特点选择

## 技术细节

### 依赖模块
- **OpenCV**: 图像处理和计算机视觉
- **NumPy**: 数值计算和数组操作
- **PIL**: 图像格式支持
- **Pathlib**: 路径操作（Python 3.8+）

### 算法优化
- **向量化操作**: 使用NumPy进行高效计算
- **内存预分配**: 减少内存分配开销
- **缓存友好**: 优化内存访问模式

### 兼容性
- **Python版本**: 3.8+
- **操作系统**: Windows, Linux, macOS
- **中文路径**: 完全支持

## 最佳实践

### 数据准备
1. **基准图像标准化**: 使用统一格式和分辨率
2. **质量控制**: 确保图像清晰度和一致性
3. **命名规范**: 使用有意义的文件名

### 处理流程
1. **小批量测试**: 先用少量数据测试参数设置
2. **结果验证**: 人工验证高置信度匹配的准确性
3. **迭代优化**: 根据结果调整基准库和参数

### 性能优化
1. **批量处理**: 合理安排处理批次大小
2. **资源管理**: 监控内存和磁盘使用
3. **并行处理**: 考虑使用多进程处理大量文件

## 相关文件

- **3_match_cached.py**: 缓存优化版本，适用于大批量处理
- **1_helper.py**: 环境检查和辅助工具
- **5_ocr.py**: OCR金额识别工具
- **build_cache.py**: 特征缓存构建工具